<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
    />
    <title>Base Mini Puzzle</title>
    <style>
      :root {
        --bg: #050816;
        --bg-soft: #0b1020;
        --accent: #42e8e0;
        --accent-soft: rgba(66, 232, 224, 0.18);
        --accent-strong: #33b8b1;
        --accent-warn: #ffb347;
        --text-main: #f9fafb;
        --text-muted: #9ca3af;
        --tile-bg: #111827;
        --tile-border: #1f2937;
        --radius-lg: 18px;
        --radius-md: 14px;
        --radius-pill: 999px;
        --shadow-soft: 0 24px 60px rgba(0, 0, 0, 0.6);
        --shadow-tile: 0 10px 25px rgba(0, 0, 0, 0.6);
        --transition-fast: 0.15s ease-out;
        --transition-med: 0.22s ease-out;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
        color: var(--text-main);
        -webkit-font-smoothing: antialiased;
      }

      body {
        display: flex;
        align-items: stretch;
        justify-content: center;
      }

      .app {
        position: relative;
        flex: 1;
        max-width: 480px;
        margin: 0 auto;
        padding: 16px 16px 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      @media (min-width: 480px) {
        .app {
          padding-top: 24px;
        }
      }

      .card {
        background: radial-gradient(circle at top left, #111827 0, #020617 55%);
        border-radius: 24px;
        border: 1px solid rgba(148, 163, 184, 0.1);
        box-shadow: var(--shadow-soft);
        padding: 16px 16px 18px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        inset: -40%;
        background: radial-gradient(
          circle at top right,
          rgba(66, 232, 224, 0.16),
          transparent 60%
        );
        opacity: 0.9;
        pointer-events: none;
      }

      .card-inner {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      header.app-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .brand-logo {
        width: 32px;
        height: 32px;
        border-radius: 12px;
        background: conic-gradient(
          from 210deg,
          #22d3ee,
          #22c55e,
          #eab308,
          #22d3ee
        );
        padding: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 16px 30px rgba(15, 23, 42, 0.8);
      }

      .brand-logo-inner {
        width: 100%;
        height: 100%;
        border-radius: inherit;
        background: radial-gradient(circle at 20% 0, #0ea5e9 0, #020617 55%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #e0f2fe;
        font-weight: 700;
        letter-spacing: 0.04em;
        font-size: 0.75rem;
      }

      .brand-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .brand-title {
        font-size: 1rem;
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .brand-subtitle {
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: var(--radius-pill);
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.18);
        color: var(--text-muted);
        font-size: 0.7rem;
      }

      .pill-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
      }

      .pill-label {
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .wallet-btn {
        flex-shrink: 0;
        border-radius: 999px;
        border: 0;
        padding: 8px 14px;
        font-size: 0.8rem;
        font-weight: 600;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: #e0f2fe;
        background: linear-gradient(135deg, #0ea5e9, #22c55e);
        box-shadow: 0 10px 25px rgba(8, 47, 73, 0.8);
        cursor: pointer;
        transition: transform var(--transition-fast),
          box-shadow var(--transition-fast), filter var(--transition-fast);
      }

      .wallet-btn span {
        font-size: 0.7rem;
      }

      .wallet-indicator {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
      }

      .wallet-btn:hover {
        filter: brightness(1.05);
        transform: translateY(-1px);
        box-shadow: 0 14px 32px rgba(8, 47, 73, 0.9);
      }

      .wallet-btn:active {
        transform: translateY(0);
        box-shadow: 0 8px 18px rgba(8, 47, 73, 0.8);
      }

      main {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .status-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .status-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-chip {
        padding: 6px 10px;
        border-radius: var(--radius-pill);
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.18);
        font-size: 0.75rem;
        color: var(--text-muted);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .status-chip strong {
        font-weight: 600;
        color: var(--text-main);
      }

      .reset-btn {
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.95);
        color: var(--text-main);
        padding: 6px 12px;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: background var(--transition-fast),
          border-color var(--transition-fast), transform var(--transition-fast);
      }

      .reset-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: var(--accent-warn);
        box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.1);
      }

      .reset-btn:hover {
        background: rgba(17, 24, 39, 0.95);
        transform: translateY(-0.5px);
      }

      .reset-btn:active {
        transform: translateY(0);
      }

      .help-text {
        font-size: 0.74rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .help-badge {
        padding: 3px 7px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.18);
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.07em;
      }

      .puzzle-shell {
        position: relative;
        border-radius: 26px;
        padding: 12px;
        background: radial-gradient(circle at top, #020617 0, #020617 55%);
        border: 1px solid rgba(148, 163, 184, 0.18);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.75);
      }

      .puzzle-shell::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: radial-gradient(
          circle at 0 0,
          rgba(66, 232, 224, 0.18),
          transparent 55%
        );
        opacity: 0.35;
        pointer-events: none;
      }

      .puzzle-shell-inner {
        position: relative;
        z-index: 1;
      }

      .puzzle-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        width: 100%;
        max-width: 360px;
        margin: 0 auto;
        aspect-ratio: 1 / 1;
      }

      .tile {
        border-radius: 18px;
        border: 1px solid var(--tile-border);
        background: radial-gradient(circle at top, #1e293b 0, #020617 80%);
        color: #e5e7eb;
        font-size: clamp(1.1rem, 4vw, 1.4rem);
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-tile);
        cursor: pointer;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        transition: transform var(--transition-med),
          box-shadow var(--transition-med), border-color var(--transition-med),
          background var(--transition-med), color var(--transition-med),
          opacity var(--transition-fast), filter var(--transition-fast);
      }

      .tile::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: radial-gradient(
          circle at 20% 0,
          rgba(248, 250, 252, 0.32),
          transparent 55%
        );
        opacity: 0;
        transition: opacity var(--transition-med);
        pointer-events: none;
      }

      .tile:not(.tile-empty):hover {
        transform: translateY(-1px);
        border-color: rgba(96, 165, 250, 0.9);
        box-shadow: 0 16px 40px rgba(37, 99, 235, 0.85);
      }

      .tile:not(.tile-empty):active {
        transform: translateY(0);
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.9);
      }

      .tile-adjacent {
        /* –ü–ª–∏—Ç–∫–∞, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ —Å–¥–≤–∏–Ω—É—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å */
        border-color: rgba(96, 165, 250, 0.8);
        background: radial-gradient(circle at top, #0f172a 0, #020617 80%);
      }

      .tile-adjacent::before {
        opacity: 0.85;
      }

      .tile-correct {
        /* –ü–ª–∏—Ç–∫–∞ –Ω–∞ —Å–≤–æ—ë–º –º–µ—Å—Ç–µ ‚Äî –º—è–≥–∫–∞—è –∑–µ–ª—ë–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ */
        border-color: rgba(52, 211, 153, 0.6);
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.28);
      }

      .tile-empty {
        background: radial-gradient(circle at top, #020617 0, #020617 80%);
        border-style: dashed;
        border-color: rgba(31, 41, 55, 0.9);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
        cursor: default;
      }

      .tile-empty::before {
        display: none;
      }

      .tile-solved {
        /* –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–±–µ–¥—ã ‚Äî –±–æ–ª–µ–µ —Å–∏–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç */
        border-color: rgba(52, 211, 153, 0.95);
        box-shadow: 0 18px 40px rgba(16, 185, 129, 0.8);
      }

      .tile-solved::before {
        opacity: 1;
      }

      .footer {
        font-size: 0.7rem;
        color: var(--text-muted);
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
        padding: 0 2px;
      }

      .footer-badge {
        padding: 4px 9px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(15, 23, 42, 0.9);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.6rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .footer-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: var(--accent);
      }

      .footer-text {
        text-align: right;
      }

      .footer-text span {
        color: #e5e7eb;
      }

      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.88);
        backdrop-filter: blur(12px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 50;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.22s ease-out;
      }

      .overlay.visible {
        opacity: 1;
        pointer-events: auto;
      }

      .overlay-card {
        width: 100%;
        max-width: 360px;
        border-radius: 24px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: radial-gradient(circle at top, #0b1120 0, #020617 55%);
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.8);
        padding: 20px 18px 18px;
        position: relative;
        overflow: hidden;
      }

      .overlay-card::before {
        content: "";
        position: absolute;
        inset: -40%;
        background: radial-gradient(
          circle at top right,
          rgba(45, 212, 191, 0.25),
          transparent 55%
        );
        opacity: 0.9;
        pointer-events: none;
      }

      .overlay-inner {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .overlay-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .overlay-title-main {
        font-size: 1.25rem;
        font-weight: 700;
      }

      .overlay-title-sub {
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .badge-win {
        padding: 5px 10px;
        border-radius: 999px;
        background: rgba(22, 163, 74, 0.2);
        border: 1px solid rgba(34, 197, 94, 0.7);
        color: #bbf7d0;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .badge-win-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #22c55e;
      }

      .overlay-stats {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 18px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.25);
      }

      .overlay-stat {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .overlay-stat-label {
        font-size: 0.7rem;
        color: var(--text-muted);
      }

      .overlay-stat-value {
        font-size: 0.95rem;
        font-weight: 600;
      }

      .overlay-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .primary-btn,
      .ghost-btn {
        flex: 1;
        border-radius: var(--radius-pill);
        padding: 8px 12px;
        font-size: 0.8rem;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        cursor: pointer;
        border: 0;
        transition: transform var(--transition-fast),
          box-shadow var(--transition-fast), background var(--transition-fast),
          color var(--transition-fast), border-color var(--transition-fast),
          opacity var(--transition-fast);
      }

      .primary-btn {
        background: linear-gradient(135deg, #0ea5e9, #22c55e);
        color: #e0f2fe;
        box-shadow: 0 12px 28px rgba(8, 47, 73, 0.9);
      }

      .primary-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 36px rgba(8, 47, 73, 1);
      }

      .primary-btn:active {
        transform: translateY(0);
        box-shadow: 0 10px 24px rgba(8, 47, 73, 0.95);
      }

      .ghost-btn {
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.35);
        color: var(--text-main);
      }

      .ghost-btn:hover {
        background: rgba(17, 24, 39, 0.95);
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 360px) {
        .card {
          padding: 14px;
        }

        .status-row {
          flex-direction: column;
          align-items: flex-start;
        }

        header.app-header {
          align-items: flex-start;
        }

        .wallet-btn {
          padding-inline: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <div class="card-inner">
          <header class="app-header">
            <div class="brand">
              <div class="brand-logo">
                <div class="brand-logo-inner">B</div>
              </div>
              <div class="brand-text">
                <div class="brand-title">Base Puzzle</div>
                <div class="brand-subtitle">
                  –ú–∏–Ω–∏-–∏–≥—Ä–∞ –¥–ª—è Base Mini App
                </div>
              </div>
            </div>
            <button id="walletButton" class="wallet-btn" type="button">
              <div class="wallet-indicator"></div>
              <span id="walletButtonLabel">Connect Wallet</span>
            </button>
          </header>

          <main>
            <div class="status-row">
              <div class="status-group">
                <div class="status-chip">
                  <span>–•–æ–¥—ã</span>
                  <strong id="movesCount">0</strong>
                </div>
                <div class="pill">
                  <span class="pill-dot"></span>
                  <span class="pill-label">3 √ó 3</span>
                </div>
              </div>
              <button id="resetButton" class="reset-btn" type="button">
                <span class="reset-dot"></span>
                <span>–°–±—Ä–æ—Å–∏—Ç—å</span>
              </button>
            </div>

            <div class="help-text">
              <span class="help-badge">–¶–µ–ª—å</span>
              <span>–°–æ–±–µ—Ä–∏ –ø–ª–∏—Ç–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É –æ—Ç 1 –¥–æ 8.</span>
            </div>

            <div class="puzzle-shell">
              <div class="puzzle-shell-inner">
                <div id="puzzle" class="puzzle-grid" aria-label="–ü–æ–ª–µ –ø–∞–∑–ª–∞">
                  <!-- –ü–ª–∏—Ç–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
                </div>
              </div>
            </div>
          </main>

          <footer class="footer">
            <div class="footer-badge">
              <span class="footer-dot"></span>
              <span>Ready for Base</span>
            </div>
            <div class="footer-text">
              <div>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–¥ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å <span>Base</span>.</div>
              <div>Onchain‚Äë–ª–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–∏—Ç—Å—è –ø–æ–∑–∂–µ.</div>
            </div>
          </footer>
        </div>
      </div>
    </div>

    <div id="winOverlay" class="overlay">
      <div class="overlay-card">
        <div class="overlay-inner">
          <div class="overlay-title">
            <div>
              <div class="overlay-title-main">–ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω üéâ</div>
              <div class="overlay-title-sub">
                –û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –ì–æ—Ç–æ–≤–æ –¥–ª—è Base Mini App.
              </div>
            </div>
            <div class="badge-win">
              <span class="badge-win-dot"></span>
              <span>Win</span>
            </div>
          </div>

          <div class="overlay-stats">
            <div class="overlay-stat">
              <span class="overlay-stat-label">–•–æ–¥—ã</span>
              <span id="finalMoves" class="overlay-stat-value">0</span>
            </div>
            <div class="overlay-stat">
              <span class="overlay-stat-label">–†–µ–∂–∏–º</span>
              <span class="overlay-stat-value">3 √ó 3</span>
            </div>
          </div>

          <div class="overlay-actions">
            <button id="publishButton" class="primary-btn" type="button">
              <span>–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</span>
            </button>
            <button id="playAgainButton" class="ghost-btn" type="button">
              <span>–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // -----------------------------
      // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–∞–∑–ª–∞
      // -----------------------------

      const GRID_SIZE = 3; // 3x3 –ø–æ–ª–µ
      const TILE_COUNT = GRID_SIZE * GRID_SIZE - 1; // 8 –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–ª–∏—Ç–æ–∫

      // -----------------------------
      // –°–æ—Å—Ç–æ—è–Ω–∏–µ
      // -----------------------------

      const state = {
        tiles: [],
        moves: 0,
        isSolved: false,
        canInteract: true,
      };

      // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞ / Base Mini App
      const walletState = {
        connected: false,
        address: null,
        provider: null,
        // –í –±—É–¥—É—â–µ–º —Å—é–¥–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å chainId, sessionId –∏ —Ç.–ø.
      };

      // -----------------------------
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DOM
      // -----------------------------

      const puzzleEl = document.getElementById("puzzle");
      const movesCountEl = document.getElementById("movesCount");
      const finalMovesEl = document.getElementById("finalMoves");
      const resetButton = document.getElementById("resetButton");
      const winOverlay = document.getElementById("winOverlay");
      const publishButton = document.getElementById("publishButton");
      const playAgainButton = document.getElementById("playAgainButton");
      const walletButton = document.getElementById("walletButton");
      const walletButtonLabel = document.getElementById("walletButtonLabel");

      // -----------------------------
      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
      // -----------------------------

      function getIndex(row, col) {
        return row * GRID_SIZE + col;
      }

      function getCoords(index) {
        return {
          row: Math.floor(index / GRID_SIZE),
          col: index % GRID_SIZE,
        };
      }

      function isAdjacentToEmpty(index) {
        const emptyIndex = state.tiles.indexOf(null);
        if (emptyIndex === -1) return false;
        const { row, col } = getCoords(index);
        const { row: emptyRow, col: emptyCol } = getCoords(emptyIndex);
        const rowDiff = Math.abs(row - emptyRow);
        const colDiff = Math.abs(col - emptyCol);
        return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
      }

      function isSolved(tiles) {
        for (let i = 0; i < TILE_COUNT; i++) {
          if (tiles[i] !== i + 1) return false;
        }
        return tiles[TILE_COUNT] === null;
      }

      // –ü–æ–¥—Å—á—ë—Ç —á–∏—Å–ª–∞ –∏–Ω–≤–µ—Ä—Å–∏–π –≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–∏–≥–Ω–æ—Ä–∏—Ä—É—è –ø—É—Å—Ç—É—é –∫–ª–µ—Ç–∫—É)
      function countInversions(arr) {
        const nums = arr.filter((n) => n !== null);
        let inversions = 0;
        for (let i = 0; i < nums.length; i++) {
          for (let j = i + 1; j < nums.length; j++) {
            if (nums[i] > nums[j]) inversions++;
          }
        }
        return inversions;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ —Ä–µ—à–∞–µ–º–æ–π
      function isSolvable(tiles) {
        const inversions = countInversions(tiles);

        if (GRID_SIZE % 2 === 1) {
          // –î–ª—è –ø–æ–ª—è –Ω–µ—á—ë—Ç–Ω–æ–π —à–∏—Ä–∏–Ω—ã (3x3, 5x5 –∏ —Ç.–ø.) ‚Äî –∏–Ω–≤–µ—Ä—Å–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á—ë—Ç–Ω–æ–µ —á–∏—Å–ª–æ
          return inversions % 2 === 0;
        }

        // –û–±–æ–±—â—ë–Ω–Ω—ã–π —Å–ª—É—á–∞–π –¥–ª—è —á—ë—Ç–Ω–æ–π —à–∏—Ä–∏–Ω—ã (–Ω–∞ –±—É–¥—É—â–µ–µ, –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å 4x4)
        const emptyIndex = tiles.indexOf(null);
        const { row } = getCoords(emptyIndex); // 0‚Äëbased —Å–≤–µ—Ä—Ö—É
        const rowFromBottom = GRID_SIZE - row; // 1‚Äëbased —Å–Ω–∏–∑—É

        // –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ:
        // - –µ—Å–ª–∏ –ø—É—Å—Ç–∞—è –∫–ª–µ—Ç–∫–∞ –Ω–∞ –Ω–µ—á—ë—Ç–Ω–æ–π —Å—Ç—Ä–æ–∫–µ —Å–Ω–∏–∑—É ‚Äî —á–∏—Å–ª–æ –∏–Ω–≤–µ—Ä—Å–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á—ë—Ç–Ω—ã–º
        // - –µ—Å–ª–∏ –Ω–∞ —á—ë—Ç–Ω–æ–π —Å—Ç—Ä–æ–∫–µ —Å–Ω–∏–∑—É ‚Äî —á–∏—Å–ª–æ –∏–Ω–≤–µ—Ä—Å–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ—á—ë—Ç–Ω—ã–º
        if (rowFromBottom % 2 === 1) {
          return inversions % 2 === 0;
        } else {
          return inversions % 2 === 1;
        }
      }

      function createSolvableShuffle() {
        const base = [];
        for (let i = 1; i <= TILE_COUNT; i++) base.push(i);
        base.push(null);

        let shuffled = base.slice();

        // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º, –ø–æ–∫–∞ –ø–æ–∑–∏—Ü–∏—è –Ω–µ —Å—Ç–∞–Ω–µ—Ç —Ä–µ—à–∞–µ–º–æ–π
        // –∏ –Ω–µ —Å–æ–≤–ø–∞–¥—ë—Ç —Å —Ä–µ—à—ë–Ω–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (—á—Ç–æ–±—ã –Ω–µ –Ω–∞—á–∏–Ω–∞—Ç—å —Å—Ä–∞–∑—É —Å –ø–æ–±–µ–¥—ã)
        do {
          shuffled = shuffled
            .slice()
            .sort(() => Math.random() - 0.5);
        } while (!isSolvable(shuffled) || isSolved(shuffled));

        return shuffled;
      }

      function updateMoves(delta) {
        state.moves += delta;
        movesCountEl.textContent = String(state.moves);
      }

      function resetGame() {
        state.tiles = createSolvableShuffle();
        state.moves = 0;
        state.isSolved = false;
        state.canInteract = true;
        movesCountEl.textContent = "0";
        hideWinOverlay();
        renderPuzzle();
      }

      function renderPuzzle() {
        puzzleEl.innerHTML = "";

        state.tiles.forEach((value, index) => {
          const tile = document.createElement("button");
          tile.type = "button";
          tile.classList.add("tile");

          if (value === null) {
            tile.classList.add("tile-empty");
            tile.setAttribute("aria-label", "–ü—É—Å—Ç–∞—è –∫–ª–µ—Ç–∫–∞");
          } else {
            tile.textContent = String(value);
            tile.setAttribute("aria-label", "–ü–ª–∏—Ç–∫–∞ " + value);

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Ö–æ–¥–∞
            if (isAdjacentToEmpty(index)) {
              tile.classList.add("tile-adjacent");
            }

            // –ú—è–≥–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–ª–∏—Ç–æ–∫, —Å—Ç–æ—è—â–∏—Ö –Ω–∞ —Å–≤–æ—ë–º –º–µ—Å—Ç–µ
            const isInCorrectPlace = index === value - 1;
            if (isInCorrectPlace) {
              tile.classList.add("tile-correct");
              // –ü–æ—Å–ª–µ –ø–æ–±–µ–¥—ã —É—Å–∏–ª–∏–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–ª–∏—Ç–æ–∫
              if (state.isSolved) {
                tile.classList.add("tile-solved");
              }
            }

            tile.addEventListener("click", () => handleTileClick(index));
            tile.addEventListener("touchend", (e) => {
              e.preventDefault();
              handleTileClick(index);
            });
          }

          puzzleEl.appendChild(tile);
        });
      }

      function handleTileClick(index) {
        if (!state.canInteract || state.isSolved) return;
        const clickedValue = state.tiles[index];
        if (clickedValue === null) return;

        if (!isAdjacentToEmpty(index)) {
          // –ù–µ–±–æ–ª—å—à–æ–π –º—è–≥–∫–∏–π —Ñ–∏–¥–±—ç–∫: "–º–∏–∫—Ä–æ-—à—ç–π–∫"
          const tileEl = puzzleEl.children[index];
          tileEl.style.transform = "translateY(-1px) scale(0.98)";
          setTimeout(() => {
            tileEl.style.transform = "";
          }, 110);
          return;
        }

        const emptyIndex = state.tiles.indexOf(null);
        [state.tiles[index], state.tiles[emptyIndex]] = [
          state.tiles[emptyIndex],
          state.tiles[index],
        ];

        updateMoves(1);
        renderPuzzle();

        if (isSolved(state.tiles)) {
          state.isSolved = true;
          state.canInteract = false;
          handleWin();
        }
      }

      function handleWin() {
        // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
        state.tiles.forEach((value, index) => {
          if (value && index === value - 1 && puzzleEl.children[index]) {
            puzzleEl.children[index].classList.add("tile-solved");
          }
        });
        finalMovesEl.textContent = String(state.moves);
        showWinOverlay();
      }

      function showWinOverlay() {
        winOverlay.classList.add("visible");
      }

      function hideWinOverlay() {
        winOverlay.classList.remove("visible");
      }

      async function copyResultToClipboard() {
        const text = `Base Puzzle: —Å–æ–±—Ä–∞–ª(–∞) –ø–∞–∑–ª 3√ó3 –∑–∞ ${state.moves} —Ö–æ–¥–æ–≤.`;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(text);
          } catch {
            // –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
          }
        }
      }

      // -----------------------------
      // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–¥ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é Base / Coinbase Wallet
      // -----------------------------

      /**
       * –ë–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è "Mini App" –æ–∫—Ä—É–∂–µ–Ω–∏—è.
       * –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å SDK Base / Coinbase Wallet,
       * –Ω–∞–≤–µ—à–∏–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏—è —Å–µ—Å—Å–∏–∏ –∏ —Ç.–ø.
       */
      function initBaseMiniAppEnvironment() {
        // TODO: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Mini App SDK, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω:
        // - –ø—Ä–æ–≤–µ—Ä–∫–∞ window.BaseMiniApp –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
        // - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, chainId –∏ –¥—Ä.
        //
        // –ü—Ä–∏–º–µ—Ä:
        // if (window.BaseMiniApp) {
        //   walletState.provider = window.BaseMiniApp.provider;
        // }
      }

      /**
       * –ó–∞–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞.
       * –°–µ–π—á–∞—Å –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ onchain-–∫–æ–¥–∞, —Ç–æ–ª—å–∫–æ UI‚Äë–ø–æ–≤–µ–¥–µ–Ω–∏–µ.
       */
      async function connectWallet() {
        // –ó–¥–µ—Å—å –≤ –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é:
        // 1) –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä Base Mini App
        // 2) –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Coinbase Wallet SDK
        // 3) –ü–∞–¥–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π window.ethereum

        // –ü—Ä–∏–º–µ—Ä –º—è–≥–∫–æ–≥–æ fallback'–∞ –Ω–∞ window.ethereum (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ onchain‚Äë—Ñ–ª–æ—É):
        const ethereum = window.ethereum;

        if (!ethereum) {
          // –°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Å–æ–ª—å, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å UX
          console.warn(
            "[Base Puzzle] –ü—Ä–æ–≤–∞–π–¥–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. " +
              "–ü–æ–∑–∂–µ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Base / Coinbase Wallet."
          );
          // –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å in‚Äëapp tooltip / snackbar
          return;
        }

        try {
          walletButton.disabled = true;
          walletButtonLabel.textContent = "Connecting...";

          // –í —Ä–µ–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å accounts / session
          const accounts = await ethereum.request({
            method: "eth_requestAccounts",
          });

          const address = Array.isArray(accounts) ? accounts[0] : null;
          if (address) {
            walletState.connected = true;
            walletState.address = address;
            walletState.provider = ethereum;
          }
        } catch (error) {
          console.error("[Base Puzzle] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ—à–µ–ª—å–∫–∞:", error);
        } finally {
          walletButton.disabled = false;
          updateWalletUI();
        }
      }

      function shortenAddress(address) {
        if (!address) return "";
        return (
          address.slice(0, 4) +
          "‚Ä¶" +
          address.slice(address.length - 4, address.length)
        );
      }

      function updateWalletUI() {
        const indicator = walletButton.querySelector(".wallet-indicator");

        if (walletState.connected && walletState.address) {
          walletButtonLabel.textContent = shortenAddress(walletState.address);
          walletButtonLabel.style.fontVariantNumeric = "tabular-nums";
          walletButtonLabel.style.letterSpacing = "0.06em";
          indicator.style.background = "#22c55e";
          indicator.style.boxShadow = "0 0 0 4px rgba(34,197,94,0.3)";
        } else {
          walletButtonLabel.textContent = "Connect Wallet";
          walletButtonLabel.style.fontVariantNumeric = "";
          walletButtonLabel.style.letterSpacing = "";
          indicator.style.background = "rgba(15,23,42,0.9)";
          indicator.style.boxShadow = "none";
        }
      }

      // -----------------------------
      // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      // -----------------------------

      resetButton.addEventListener("click", () => {
        resetGame();
      });

      playAgainButton.addEventListener("click", () => {
        hideWinOverlay();
        resetGame();
      });

      publishButton.addEventListener("click", () => {
        const message =
          "Publish to Base (onchain –ª–æ–≥–∏–∫–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ)";
        // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞–∂–µ–º –ø—Ä–æ—Å—Ç–æ–µ –æ–∫–Ω–æ
        alert(message);
        // –ò –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ—Å—Ç–∞–≤–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
        console.log(message);
      });

      walletButton.addEventListener("click", () => {
        if (!walletState.connected) {
          connectWallet();
        } else {
          // –ü—Ä–æ—Å—Ç–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
          // –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∫–ª–∏–∫–µ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫, –º–µ–Ω—é "Disconnect" –∏ —Ç.–ø.
          console.log(
            "[Base Puzzle] –ö–æ—à–µ–ª—ë–∫ —É–∂–µ –ø–æ–¥–∫–ª—é—á—ë–Ω:",
            walletState.address
          );
        }
      });

      // -----------------------------
      // –°—Ç–∞—Ä—Ç
      // -----------------------------

      initBaseMiniAppEnvironment();
      resetGame();
    </script>
  </body>
</html>

